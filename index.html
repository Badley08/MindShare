<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindShare - Partagez vos idées</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Le bloc script type="module" contient les variables globales de l'environnement -->
    <script type="module">
        // Global variables for Firebase configuration (provided by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    </script>
    <script>
        // Configuration Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#121212',
                            card: '#1e1e1e',
                            text: '#e0e0e0',
                            accent: '#bb86fc'
                        },
                        light: {
                            bg: '#ffffff',
                            card: '#f5f5f5',
                            text: '#333333',
                            accent: '#6200ee'
                        },
                        // Couleur Google pour le bouton d'authentification
                        google: '#4285F4', 
                    },
                    boxShadow: {
                        'google': '0 2px 4px 0 rgba(0,0,0,.25)',
                    }
                },
            },
        }
    </script>
    <style>
        /* Styles CSS personnalisés pour les thèmes */
        :root {
            --bg-color: #ffffff;
            --card-color: #f5f5f5;
            --text-color: #333333;
            --accent-color: #6200ee;
        }

        .theme-dark {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #bb86fc;
        }

        .theme-neon {
            --bg-color: #000000;
            --card-color: #1a1a2e;
            --text-color: #00ffcc;
            --accent-color: #ff00ff;
        }

        .theme-hacker {
            --bg-color: #0a0a0a;
            --card-color: #0d0208;
            --text-color: #00ff41;
            --accent-color: #008f11;
        }
        
        /* Appliquer les variables CSS au body */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        /* Style des cartes de publication */
        .post-card {
            background-color: var(--card-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Bouton principal */
        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Lien de toggle (connexion/inscription) */
        .toggle-link {
            color: var(--accent-color);
            cursor: pointer;
            font-weight: 600;
            transition: color 0.2s;
        }
        .toggle-link:hover {
            opacity: 0.8;
        }

        /* Style du toast (notification) */
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 999;
            left: 50%;
            /* Déplacé vers le bas de l'en-tête pour éviter le masquage */
            top: 70px; 
            transform: translateX(-50%);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s ease;
        }

        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .toast.error { background-color: #dc3545; }
        .toast.success { background-color: #28a745; }
        
        /* Modal d'Authentification - Responsive et Centré */
        .auth-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex; /* Utilisation de flexbox pour centrer */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-modal-content {
            width: 90%; /* Pour les petits écrans */
            max-width: 450px; /* Taille max pour desktop */
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

    </style>
</head>
<body class="theme-light">

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Main Application Content -->
    <div id="app-container" class="min-h-screen p-4 transition-opacity duration-500 opacity-0">
        <header class="flex justify-between items-center py-4 border-b border-gray-700/50 mb-6">
            <h1 class="text-3xl font-bold text-[var(--accent-color)]">MindShare</h1>
            <div class="flex items-center space-x-4">
                <!-- Seul le bouton d'icône d'engrenage est conservé pour le changement de thème -->
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-[var(--card-color)] transition-colors">
                    <i class="fas fa-cog text-xl" id="theme-icon"></i> 
                </button>
                <div class="text-sm rounded-full bg-[var(--accent-color)] text-white px-3 py-1.5" id="user-info">
                    <!-- User ID will be displayed here -->
                </div>
                <button id="logout-button" class="btn-primary px-4 py-2 rounded-lg text-sm">Déconnexion</button>
            </div>
        </header>

        <main class="max-w-xl mx-auto">
            <!-- New Post Form -->
            <div class="post-card rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-semibold mb-4">Partager une idée</h2>
                <form id="new-post-form">
                    <textarea id="post-content" rows="4" maxlength="300" placeholder="Qu'avez-vous en tête ? (Max 300 caractères)" required
                        class="w-full p-3 rounded-lg border border-gray-600/50 focus:ring-2 focus:ring-[var(--accent-color)] bg-[var(--bg-color)] text-[var(--text-color)] resize-none"></textarea>
                    <div class="flex justify-between items-center mt-3">
                        <span id="char-count" class="text-sm text-gray-500">0/300</span>
                        <button type="submit" class="btn-primary px-6 py-2 rounded-lg">Publier</button>
                    </div>
                </form>
            </div>

            <!-- Posts List -->
            <div id="posts-container" class="space-y-6">
                <!-- Posts will be injected here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- AUTHENTICATION MODAL (Hidden by default) -->
    <!-- Le modal est positionné en plein écran avec flexbox pour le centrer parfaitement -->
    <div id="auth-modal" class="auth-modal-backdrop hidden">
        <div id="auth-content" class="auth-modal-content card post-card p-8 rounded-xl">
            <!-- Login Form -->
            <div id="login-container">
                <h2 class="text-3xl font-bold mb-6 text-center text-[var(--accent-color)]">Se connecter</h2>

                <!-- Bouton Connexion Google (avec les vraies couleurs) -->
                <button id="google-login-button" 
                    class="w-full py-3 rounded-lg font-medium flex items-center justify-center space-x-3 transition-all duration-200 border border-gray-300 text-gray-700 bg-white shadow-google"
                    style="background-color: #ffffff; color: #4285F4; border-color: #4285F4; padding: 10px 0;">
                    <i class="fab fa-google text-lg"></i>
                    <span>Connexion avec Google</span>
                </button>
                
                <p class="text-center my-4 text-gray-500">ou</p>

                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="font-medium">Email</label>
                        <input type="email" id="login-email" required
                            class="w-full p-3 mt-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--accent-color)] bg-[var(--bg-color)] text-[var(--text-color)]">
                    </div>
                    <div>
                        <label for="login-password" class="font-medium">Mot de passe</label>
                        <input type="password" id="login-password" required
                            class="w-full p-3 mt-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--accent-color)] bg-[var(--bg-color)] text-[var(--text-color)]">
                    </div>
                    <button type="submit" class="btn-primary w-full py-3 mt-4 rounded-lg">Se connecter</button>
                </form>

                <p class="mt-6 text-sm text-center text-gray-500">
                    Pas encore de compte ?
                    <span id="show-signup" class="toggle-link">S'inscrire</span>
                </p>
            </div>

            <!-- Signup Form (Hidden by default) -->
            <div id="signup-container" class="hidden">
                <h2 class="text-3xl font-bold mb-6 text-center text-[var(--accent-color)]">Créer un compte</h2>
                
                 <!-- Bouton Connexion Google (avec les vraies couleurs) -->
                <button id="google-signup-button" 
                    class="w-full py-3 rounded-lg font-medium flex items-center justify-center space-x-3 transition-all duration-200 border border-gray-300 text-gray-700 bg-white shadow-google"
                    style="background-color: #ffffff; color: #4285F4; border-color: #4285F4; padding: 10px 0;">
                    <i class="fab fa-google text-lg"></i>
                    <span>S'inscrire avec Google</span>
                </button>
                
                <p class="text-center my-4 text-gray-500">ou</p>

                <form id="signup-form" class="space-y-4">
                    <div>
                        <label for="signup-email" class="font-medium">Email</label>
                        <input type="email" id="signup-email" required
                            class="w-full p-3 mt-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--accent-color)] bg-[var(--bg-color)] text-[var(--text-color)]">
                    </div>
                    <div>
                        <label for="signup-password" class="font-medium">Mot de passe</label>
                        <input type="password" id="signup-password" required
                            class="w-full p-3 mt-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-[var(--accent-color)] bg-[var(--bg-color)] text-[var(--text-color)]">
                    </div>
                    <button type="submit" class="btn-primary w-full py-3 mt-4 rounded-lg">S’inscrire</button>
                </form>

                <p class="mt-6 text-sm text-center text-gray-500">
                    Déjà un compte ?
                    <span id="show-login" class="toggle-link">Se connecter</span>
                </p>
            </div>
        </div>
    </div>


    <!-- Firebase and Application Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged, 
            signOut, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword,
            GoogleAuthProvider, 
            signInWithPopup 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            updateDoc, 
            query, 
            orderBy, 
            serverTimestamp,
            arrayUnion, 
            arrayRemove,
            onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set log level to debug for better error reporting during development
        setLogLevel('debug');

        // --- GLOBAL VARIABLES ---
        let app;
        let db;
        let auth;
        let currentUser = null;
        let userId = null;
        
        // Caching for user likes (private data)
        let userLikes = new Set(); 
        
        // DOM Elements
        const appContainer = document.getElementById('app-container');
        const authModal = document.getElementById('auth-modal');
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const showSignup = document.getElementById('show-signup');
        const showLogin = document.getElementById('show-login');
        const googleLoginButton = document.getElementById('google-login-button');
        const googleSignupButton = document.getElementById('google-signup-button');
        const newPostForm = document.getElementById('new-post-form');
        const postsContainer = document.getElementById('posts-container');
        const charCount = document.getElementById('char-count');
        const postContent = document.getElementById('post-content');
        const toast = document.getElementById('toast');
        const userInfo = document.getElementById('user-info');
        const logoutButton = document.getElementById('logout-button');
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');

        // --- INITIALIZATION ---
        // Les variables globales sont maintenant accessibles car le script est de type 'module'
        const globalAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const globalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const globalInitialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        function initFirebase() {
            // FIX: Utiliser la variable globale correctement initialisée
            if (!globalFirebaseConfig) {
                showToast("Erreur: La configuration Firebase n'est pas définie.", 'error');
                return;
            }
            app = initializeApp(globalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        async function authenticateUser() {
            try {
                // FIX: Utiliser la variable globale correctement initialisée
                if (globalInitialAuthToken) {
                    await signInWithCustomToken(auth, globalInitialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no custom token is available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erreur lors de l'authentification:", error);
                showToast("Erreur d'authentification initiale. Veuillez réessayer.", 'error');
                // Even if custom token fails, we can sign in anonymously to allow Firestore read/write
                try {
                    await signInAnonymously(auth);
                } catch (anonError) {
                    console.error("Erreur d'authentification anonyme:", anonError);
                }
            }
        }
        
        // Appel des initialisations
        initFirebase();
        authenticateUser();

        // --- UI UTILITIES ---

        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function showMainContent() {
            appContainer.classList.remove('opacity-0');
            authModal.classList.add('hidden');
        }

        function showAuthPage() {
            appContainer.classList.add('opacity-0');
            authModal.classList.remove('hidden');
            // Ensure login view is shown by default when modal opens
            loginContainer.classList.remove('hidden');
            signupContainer.classList.add('hidden');
        }

        // --- THEME MANAGEMENT ---

        function getSavedTheme() {
            return localStorage.getItem('mindshare-theme') || 'light';
        }

        function applyTheme(theme) {
            document.body.className = `theme-${theme}`;
            
            // Mise à jour de l'icône pour qu'elle corresponde au thème suivant
            let nextIconClass;
            switch (theme) {
                case 'light':
                    nextIconClass = 'fa-moon';
                    break;
                case 'dark':
                    nextIconClass = 'fa-magic'; // Exemple d'icône suivante
                    break;
                case 'neon':
                    nextIconClass = 'fa-terminal'; // Exemple d'icône suivante
                    break;
                case 'hacker':
                    nextIconClass = 'fa-sun'; // Revenir à l'icône du thème clair
                    break;
                default:
                    nextIconClass = 'fa-moon';
            }
            themeIcon.className = `fas ${nextIconClass} text-xl`;

            localStorage.setItem('mindshare-theme', theme);
        }


        function toggleTheme() {
            const currentTheme = getSavedTheme();
            const newTheme = currentTheme === 'light' ? 'dark' : 
                             (currentTheme === 'dark' ? 'neon' : 
                             (currentTheme === 'neon' ? 'hacker' : 'light'));
            applyTheme(newTheme);
        }

        // Appliquer le thème au chargement
        applyTheme(getSavedTheme());
        themeToggle.addEventListener('click', toggleTheme);
        
        // --- DATE UTILITY ---

        function timeAgo(timestamp) {
            if (!timestamp) return 'Inconnu';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffSeconds < 60) return "À l'instant";
            if (diffMinutes < 60) return `Il y a ${diffMinutes} minute${diffMinutes > 1 ? 's' : ''}`;
            if (diffHours < 24) return `Il y a ${diffHours} heure${diffHours > 1 ? 's' : ''}`;
            if (diffDays < 7) return `Il y a ${diffDays} jour${diffDays > 1 ? 's' : ''}`;
            
            return date.toLocaleDateString('fr-FR');
        }

        // --- AUTHENTICATION LOGIC ---

        function updateUserInfoDisplay(user) {
            // Display User ID or a friendly identifier
            userId = user.uid;
            userInfo.textContent = user.email ? user.email.split('@')[0] : user.uid.substring(0, 8);
        }

        async function handleEmailSignup(e) {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (password.length < 6) {
                showToast("Le mot de passe doit contenir au moins 6 caractères.", 'error');
                return;
            }

            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showToast("Inscription réussie ! Connexion automatique.", 'success');
            } catch (error) {
                console.error("Erreur lors de l'inscription:", error.code, error.message);
                showToast(`Erreur d'inscription: ${error.message}`, 'error');
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Connexion réussie !", 'success');
            } catch (error) {
                console.error("Erreur lors de la connexion:", error.code, error.message);
                showToast(`Erreur de connexion: ${error.message}`, 'error');
            }
        }

        async function handleGoogleLogin(isSignup = false) {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
                showToast(`Connexion Google réussie !`, 'success');
            } catch (error) {
                console.error("Erreur lors de la connexion Google:", error.code, error.message);
                showToast(`Erreur Google: ${error.message}`, 'error');
            }
        }
        
        function handleLogout() {
            signOut(auth).then(() => {
                showToast("Déconnexion réussie.", 'info');
            }).catch((error) => {
                console.error("Erreur de déconnexion:", error);
                showToast("Échec de la déconnexion.", 'error');
            });
        }
        
        // Listeners for Auth UI
        showSignup.addEventListener('click', () => {
            loginContainer.classList.add('hidden');
            signupContainer.classList.remove('hidden');
        });
        showLogin.addEventListener('click', () => {
            loginContainer.classList.remove('hidden');
            signupContainer.classList.add('hidden');
        });
        loginForm.addEventListener('submit', handleEmailLogin);
        signupForm.addEventListener('submit', handleEmailSignup);
        googleLoginButton.addEventListener('click', () => handleGoogleLogin(false));
        googleSignupButton.addEventListener('click', () => handleGoogleLogin(true));
        logoutButton.addEventListener('click', handleLogout);

        // --- FIRESTORE / POSTS LOGIC ---
        
        // Public collection path for posts
        function getPostsCollectionRef() {
            // FIX: Utiliser la variable globale correctement initialisée
            return collection(db, `artifacts/${globalAppId}/public/data/posts`);
        }
        
        // Private collection path for user likes
        function getUserLikesDocRef() {
            // Use the current authenticated user's ID for private data
            return doc(db, `artifacts/${globalAppId}/users/${userId}/private/likes`);
        }

        // 1. CREATE POST
        async function handleNewPost(e) {
            e.preventDefault();
            const content = postContent.value.trim();
            if (!content) {
                showToast("Le contenu ne peut pas être vide.", 'error');
                return;
            }

            try {
                await addDoc(getPostsCollectionRef(), {
                    userId: userId,
                    userName: currentUser.email ? currentUser.email.split('@')[0] : userId.substring(0, 8),
                    content: content,
                    timestamp: serverTimestamp(),
                    likedBy: [] // Store UIDs of users who liked it for integrity (optional, but good practice)
                });
                postContent.value = '';
                charCount.textContent = '0/300';
                showToast("Idée publiée avec succès !", 'success');
            } catch (error) {
                console.error("Erreur lors de l'ajout du post:", error);
                showToast("Échec de la publication.", 'error');
            }
        }
        
        newPostForm.addEventListener('submit', handleNewPost);
        
        // Character counter for textarea
        postContent.addEventListener('input', () => {
            const length = postContent.value.length;
            charCount.textContent = `${length}/300`;
            if (length > 300) {
                postContent.value = postContent.value.substring(0, 300);
            }
        });

        // 2. LIKE / UNLIKE POST (CRUCIAL FIX: Real-time update)
        async function toggleLike(postId) {
            if (!currentUser) {
                showToast("Veuillez vous connecter pour aimer les publications.", 'info');
                return;
            }

            const postRef = doc(getPostsCollectionRef(), postId);
            const userLikesRef = getUserLikesDocRef();

            const isLiked = userLikes.has(postId);

            try {
                if (isLiked) {
                    // UNLIKE
                    await updateDoc(postRef, {
                        likedBy: arrayRemove(userId)
                    });
                    // This update is handled by the post listener (onSnapshot)
                    userLikes.delete(postId);
                    await setDoc(userLikesRef, { posts: Array.from(userLikes) }, { merge: true });
                    showToast("J'aime retiré.", 'info');
                } else {
                    // LIKE
                    await updateDoc(postRef, {
                        likedBy: arrayUnion(userId)
                    });
                    // This update is handled by the post listener (onSnapshot)
                    userLikes.add(postId);
                    await setDoc(userLikesRef, { posts: Array.from(userLikes) }, { merge: true });
                    showToast("J'aime ajouté !", 'success');
                }
            } catch (error) {
                console.error("Erreur lors de la mise à jour du like:", error);
                showToast(`Erreur: ${error.message}`, 'error');
            }
        }
        
        // 3. LISTEN FOR USER LIKES (PRIVATE DATA)
        function listenForUserLikes() {
            // Vérifiez si l'ID utilisateur est défini avant de démarrer l'écouteur
            if (!userId) {
                console.warn("User ID not available yet for user likes listener.");
                return;
            }

            const userLikesRef = getUserLikesDocRef();
            
            // Unsubscribe from previous listener if exists
            if (window.userLikesUnsubscribe) {
                window.userLikesUnsubscribe();
            }

            // Set up new listener for the current user's private likes document
            window.userLikesUnsubscribe = onSnapshot(userLikesRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().posts) {
                    // Update the local cache (userLikes set)
                    userLikes = new Set(docSnap.data().posts);
                } else {
                    userLikes = new Set();
                }
                
                // Rerender all posts to update the heart icon color
                if (window.postsData && window.postsData.length > 0) {
                    postsContainer.innerHTML = '';
                    window.postsData.forEach(post => renderPost(post));
                }
            }, (error) => {
                console.error("Erreur lors de l'écoute des likes de l'utilisateur:", error);
            });
        }


        // 4. LISTEN FOR POSTS (PUBLIC DATA) - REAL-TIME REFRESH FIX
        function listenForPosts() {
            const postsQuery = query(getPostsCollectionRef(), orderBy('timestamp', 'desc'));
            
            // Unsubscribe from previous listener if exists
            if (window.postsUnsubscribe) {
                window.postsUnsubscribe();
            }

            // Set up new listener
            window.postsUnsubscribe = onSnapshot(postsQuery, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    posts.push({ id: doc.id, ...data });
                });
                
                // Store posts data globally for reference
                window.postsData = posts; 
                
                // Rerender all posts
                postsContainer.innerHTML = '';
                posts.forEach(post => renderPost(post));
            }, (error) => {
                console.error("Erreur lors de l'écoute des posts:", error);
                showToast("Erreur lors du chargement des publications.", 'error');
            });
        }

        // 5. RENDER POST
        function renderPost(post) {
            const isLiked = userLikes.has(post.id);
            const likeIconClass = isLiked ? 'fas text-red-500' : 'far text-gray-500/80';
            
            const postElement = document.createElement('div');
            postElement.className = 'post-card rounded-xl p-6 transition-transform duration-200 hover:shadow-lg';
            
            // S'assurer que likedBy est un tableau pour la propriété .length
            const likeCount = Array.isArray(post.likedBy) ? post.likedBy.length : 0;

            postElement.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <p class="font-semibold text-[var(--accent-color)]">${post.userName}</p>
                        <p class="text-xs text-gray-500">${timeAgo(post.timestamp)}</p>
                    </div>
                </div>
                <p class="mb-4 whitespace-pre-wrap">${post.content}</p>
                
                <div class="flex items-center space-x-2">
                    <button class="like-button p-2 rounded-full transition-colors hover:bg-red-500/10" data-post-id="${post.id}">
                        <i class="${likeIconClass} fa-heart text-lg"></i>
                    </button>
                    <!-- Correction: On utilise likeCount pour le compte réel des likes -->
                    <span class="text-sm font-medium text-gray-500">${likeCount}</span>
                </div>
            `;
            
            // Add event listener to the like button
            postElement.querySelector('.like-button').addEventListener('click', () => toggleLike(post.id));

            postsContainer.appendChild(postElement);
        }

        // --- AUTH STATE LISTENER (Keeps user logged in) ---

        // Écouter les changements d'état d'authentification
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Important: Update userId as soon as auth is ready
                updateUserInfoDisplay(user); 
                showMainContent();
                // Start real-time listeners once authenticated
                listenForUserLikes(); 
                listenForPosts();
            } else {
                currentUser = null;
                userId = null;
                userLikes.clear();
                // Unsubscribe from listeners when user logs out
                if (window.postsUnsubscribe) window.postsUnsubscribe();
                if (window.userLikesUnsubscribe) window.userLikesUnsubscribe();
                showAuthPage();
            }
        });

    </script>
</body>
</html>
